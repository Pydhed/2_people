<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="PWA –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞—Å">
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232196F3' width='192' height='192'/><text x='96' y='120' font-size='120' fill='white' text-anchor='middle' font-weight='bold'>üíï</text></svg>">
    
    <style>
        /* CSS –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            background-color: #f0f4f8;
            background-image: linear-gradient(135deg, #f0f4f8 0%, #e8f1f7 100%);
            color: #1a1a1a; 
            overflow-x: hidden; 
            touch-action: manipulation; 
        }

        .container { display: flex; min-height: 100vh; }
        
        /* Sidebar (Desktop) */
        .sidebar { display: none; width: 280px; background: white; border-right: 1px solid #d0dce7; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; font-size: 24px; color: #2196F3; font-weight: bold; }
        .nav-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #666; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px; position: relative;}
        .nav-item:hover, .nav-item.active { background: #e3f2fd; color: #2196F3; }
        
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .screen { display: none; padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .screen.active { display: block; }
        
        @media (min-width: 1024px) { .sidebar { display: block; } .main-content { margin-left: 280px; } .bottom-nav { display: none !important; } }
        
        /* General Cards */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .timer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        @media (min-width: 600px) { .timer-grid { grid-template-columns: repeat(4, 1fr); } }

        .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(33,150,243,0.08); text-align: center; border: 1px solid #e3f2fd; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card-value { font-size: 28px; font-weight: 700; color: #2196F3; }
        .card-label { font-size: 12px; color: #999; text-transform: uppercase; margin-top: 4px; letter-spacing: 0.5px;}

        /* --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ù–æ–≤—ã–π –±–ª–æ–∫) --- */
        .stats-container {
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 1px solid #e3f2fd;
        }
        .stats-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee;
        }
        .stats-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .stats-bar-container { flex: 1; margin: 0 15px; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; display: flex;}
        .stats-bar-left { height: 100%; background: #2196F3; transition: width 1s ease; }
        .stats-bar-right { height: 100%; background: #FF9800; transition: width 1s ease; } /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞ */
        .stats-name { font-size: 12px; font-weight: bold; width: 60px; }
        .stats-val { font-size: 12px; color: #666; width: 30px; text-align: center; }

        /* --- –ë–ï–ô–î–ñ–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô --- */
        .badge {
            position: absolute;
            background-color: #ff4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        /* –ü–æ–∑–∏—Ü–∏—è –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ */
        .sidebar .badge { right: 10px; top: 12px; }
        /* –ü–æ–∑–∏—Ü–∏—è –¥–ª—è –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .bottom-nav .badge { top: 4px; right: 25%; }


        /* Input Groups */
        #dataGoalsContainer { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        @media (min-width: 900px) { #dataGoalsContainer { grid-template-columns: 1fr 1fr; align-items: start; } }

        .compact-input-group { display: flex; flex-direction: column; gap: 10px; background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e3f2fd; }
        @media (min-width: 600px) { .compact-input-group { flex-direction: row; align-items: flex-end; } }
        .compact-input-group > div { flex: 1; width: 100%; }
        .compact-input-group input { margin-bottom: 0; width: 100%; }
        .compact-input-group button { flex: 0 0 auto; width: 100%; padding: 12px 20px; }
        @media (min-width: 600px) { .compact-input-group button { width: auto; } }
        
        .compact-item-card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); border-left: 4px solid #4CAF50; position: relative; min-height: 70px; display: flex; flex-direction: column; justify-content: center; }
        .compact-item-card button { position: absolute; right: 5px; top: 5px; border: none; background: none; color: #aaa; cursor: pointer; font-size: 16px; }

        /* Chat */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 180px); }
        .messages { flex: 1; overflow-y: auto; margin-bottom: 16px; display: flex; flex-direction: column; gap: 10px; padding: 10px; width: 100%; }
        .message { display: flex; width: 100%; position: relative; }
        .message.sent { justify-content: flex-end; }
        .message.received { justify-content: flex-start; }
        .message-bubble { padding: 10px 14px; border-radius: 16px; font-size: 14px; word-wrap: break-word; position: relative; max-width: 75%; }
        .message.sent .message-bubble { background: #2196F3; color: white; border-bottom-right-radius: 2px; }
        .message.received .message-bubble { background: #ffffff; color: #1a1a1a; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .delete-msg { position: absolute; top: -8px; left: -8px; background: #ff4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; border: none; cursor: pointer; display: none; justify-content: center; align-items: center; z-index: 10;}
        .message:hover .delete-msg { display: flex; }
        .chat-input-group { display: flex; gap: 8px; padding-top: 10px; border-top: 1px solid #eee; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; background: #2196F3; color: white; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; }

        /* Wall */
        #drawingCanvasContainer { width: 100%; max-width: 600px; margin: 0 auto 15px; position: relative; padding-top: 75%; max-height: 60vh; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        #drawingCanvas { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; display: block; cursor: crosshair; touch-action: none; }
        
        /* Postcards */
        .postcards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; padding: 10px; }
        .postcard { position: relative; aspect-ratio: 3/4; background: white; padding: 0; box-shadow: 3px 3px 10px rgba(0,0,0,0.15); border-radius: 2px; border: 6px solid white; border-bottom: 25px solid white; transition: transform 0.3s; cursor: pointer; }
        .postcard img { width: 100%; height: 100%; object-fit: cover; }
        .postcard:hover { transform: scale(1.05); z-index: 100; }
        .delete-card { position: absolute; top: -15px; right: -15px; background: rgba(255, 68, 68, 1); color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 5; }
        .author-label { position: absolute; bottom: -20px; left: 0; right: 0; color: #666; font-size: 11px; padding: 2px 5px; text-align: center; font-family: cursive; }

        /* Controls */
        .btn { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 5px; font-weight: 500;}
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; }
        
        /* Bottom Nav */
        .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; height: 60px; z-index: 1000; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        .nav-tab { background: none; border: none; color: #999; font-size: 11px; display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; }
        .nav-tab.active { color: #2196F3; }
        .nav-tab-icon { font-size: 20px; margin-bottom: 2px; }
        
        /* Login & Overlays */
        #loginScreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #loginError { color: red; margin-top: 10px; display: none; }
        #fullscreenImageOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 9000; display: none; justify-content: center; align-items: center; }
        #fullscreenImageOverlay img { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; }
        .popup-close { position: absolute; top: 15px; right: 15px; font-size: 28px; font-weight: bold; color: #fff; cursor: pointer; border: none; background: none; z-index: 9001; }

        /* Holidays */
        .holiday-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 5px solid #2196F3; cursor: pointer; margin-bottom: 8px; }
        #holidayPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #2196F3; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 5000; max-width: 90%; width: 400px; display: none; max-height: 80vh; overflow-y: auto; }
        #holidayPopup .popup-close { color: #999; top: 5px; right: 5px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <h1 style="color: #2196F3; margin-bottom: 20px;">üíï –ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</h1>
    <div style="width: 100%; max-width: 300px;">
        <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">–ö—Ç–æ —Ç—ã?</label>
        <select id="loginUser">
            <option value="surikat">–°—É—Ä–∏–∫–∞—Ç</option>
            <option value="kot">–ö–æ—Ç</option>
        </select>
        <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <div id="loginError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
</div>

<div class="container" id="appContainer" style="display:none;">
    <nav class="sidebar">
        <div class="sidebar-header">üíï –ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="sidebar-nav">
            <button class="nav-item active" onclick="switchScreen('home')">üìä –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="nav-item" onclick="switchScreen('chat')">
                üí¨ –ß–∞—Ç <span class="badge" id="badge-chat-desk">0</span>
            </button>
            <button class="nav-item" onclick="switchScreen('wall')">
                üé® –°—Ç–µ–Ω–∞ <span class="badge" id="badge-wall-desk">0</span>
            </button>
            <button class="nav-item" onclick="switchScreen('postcards')">
                üìÆ –û—Ç–∫—Ä—ã—Ç–∫–∏ <span class="badge" id="badge-foto-desk">0</span>
            </button>
            <button class="nav-item" onclick="switchScreen('holidays')">üìÖ –ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button> 
            <div style="flex: 1"></div>
            <button class="nav-item" onclick="doLogout()" style="color: #ff4444; border-top: 1px solid #eee;">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </nav>

    <div class="main-content">
        <div class="screen active" id="home">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1 style="font-size: 24px; margin-bottom: 5px;">–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</h1>
                    <p style="color: #666;">–í–º–µ—Å—Ç–µ —É–∂–µ <strong id="daysTogetherDisplay">...</strong></p>
                </div>
                <button class="btn" style="width: auto; background: #ff4444; padding: 5px 12px; font-size: 13px;" onclick="doLogout()">–í—ã–π—Ç–∏</button>
            </div>
            
            <div class="timer-grid">
                <div class="card"><div class="card-value" id="daysDisplay">0</div><div class="card-label">–î–Ω–µ–π</div></div>
                <div class="card"><div class="card-value" id="hoursDisplay">0</div><div class="card-label">–ß–∞—Å–æ–≤</div></div>
                <div class="card"><div class="card-value" id="minutesDisplay">0</div><div class="card-label">–ú–∏–Ω—É—Ç</div></div>
                <div class="card"><div class="card-value" id="secondsDisplay">0</div><div class="card-label">–°–µ–∫—É–Ω–¥</div></div>
            </div>

            <h2 style="font-size: 18px; margin: 10px 0 10px;">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π</h2>
            <div class="stats-container">
                <div class="stats-row">
                    <div class="stats-name" style="color: #2196F3;">–°—É—Ä–∏–∫–∞—Ç</div>
                    <div style="font-size: 10px; color:#999;">VS</div>
                    <div class="stats-name" style="color: #FF9800; text-align: right;">–ö–æ—Ç</div>
                </div>
                
                <div style="font-size: 11px; margin-bottom: 4px; color: #666;">üíå –°–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                <div class="stats-row">
                    <div class="stats-val" id="stat-chat-1">0</div>
                    <div class="stats-bar-container">
                        <div class="stats-bar-left" id="bar-chat-1" style="width: 50%;"></div>
                        <div class="stats-bar-right" id="bar-chat-2" style="width: 50%;"></div>
                    </div>
                    <div class="stats-val" id="stat-chat-2">0</div>
                </div>

                <div style="font-size: 11px; margin-bottom: 4px; color: #666;">üì∏ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
                <div class="stats-row">
                    <div class="stats-val" id="stat-foto-1">0</div>
                    <div class="stats-bar-container">
                        <div class="stats-bar-left" id="bar-foto-1" style="width: 50%;"></div>
                        <div class="stats-bar-right" id="bar-foto-2" style="width: 50%;"></div>
                    </div>
                    <div class="stats-val" id="stat-foto-2">0</div>
                </div>

                <div style="font-size: 11px; margin-bottom: 4px; color: #666;">üé® –†–∏—Å—É–Ω–∫–æ–≤ —Å–æ–∑–¥–∞–Ω–æ</div>
                <div class="stats-row">
                    <div class="stats-val" id="stat-wall-1">0</div>
                    <div class="stats-bar-container">
                        <div class="stats-bar-left" id="bar-wall-1" style="width: 50%;"></div>
                        <div class="stats-bar-right" id="bar-wall-2" style="width: 50%;"></div>
                    </div>
                    <div class="stats-val" id="stat-wall-2">0</div>
                </div>
            </div>
            <h2 style="font-size: 18px; margin: 24px 0 10px;">–î–æ –î–Ω—è –†–æ–∂–¥–µ–Ω–∏—è</h2>
            <div class="cards-grid">
                <div class="card"><div class="card-value" id="daysToP1">...</div><div class="card-label">–°—É—Ä–∏–∫–∞—Ç (12.08)</div></div>
                <div class="card"><div class="card-value" id="daysToP2">...</div><div class="card-label">–ö–æ—Ç (18.03)</div></div>
            </div>

            <div id="dataGoalsContainer">
                <div>
                    <h2 style="font-size: 18px; margin: 0 0 10px;">üìÖ –í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã</h2>
                    <div class="compact-input-group">
                        <div><label style="font-size: 11px; color: #666;">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="impName" placeholder="–°–æ–±—ã—Ç–∏–µ"></div>
                        <div><label style="font-size: 11px; color: #666;">–î–∞—Ç–∞</label><input type="date" id="impDate"></div>
                        <button class="btn" onclick="addImportantDate()">‚ûï</button>
                    </div>
                    <div id="importantDatesContainer"></div>
                </div>

                <div>
                    <h2 style="font-size: 18px; margin: 0 0 10px;">üéØ –¶–µ–ª–∏ –∏ –ø–ª–∞–Ω—ã</h2>
                    <div class="compact-input-group">
                        <div><label style="font-size: 11px; color: #666;">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="goalName" placeholder="–¶–µ–ª—å"></div>
                        <div><label style="font-size: 11px; color: #666;">–î–∞—Ç–∞</label><input type="date" id="goalDate"></div>
                        <button class="btn" onclick="addGoal()">‚ú®</button>
                    </div>
                    <div id="goalsContainer"></div>
                </div>
            </div>
        </div>

        <div class="screen" id="chat">
            <h1>üí¨ –ß–∞—Ç</h1>
            <div class="chat-container">
                <div class="messages" id="messages"></div>
                <div class="chat-input-group">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <div class="screen" id="wall">
            <h1>üé® –†–∏—Å—É–µ–º –≤–º–µ—Å—Ç–µ</h1>
            <div id="drawingCanvasContainer">
                <canvas id="drawingCanvas"></canvas>
            </div>
            <div style="margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <span style="font-size: 11px; color: #666; margin-bottom: 4px;">–¶–≤–µ—Ç</span>
                    <input type="color" id="colorPicker" value="#000000" style="width: 40px; height: 35px; padding: 0; border: none; background: none;">
                </div>
                <button class="btn" style="width: auto; height: 35px; margin-top: 0; background: #607d8b;" onclick="undoWallDrawing()">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å</button>
                <button class="btn" style="width: auto; height: 35px; margin-top: 0;" onclick="clearCanvas()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn" style="width: auto; height: 35px; margin-top: 0;" onclick="saveWallDrawing()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <h2 style="font-size: 18px; margin: 30px 0 15px;">–ì–∞–ª–µ—Ä–µ—è —Ä–∏—Å—É–Ω–∫–æ–≤</h2>
            <div id="wallGalleryGrid" class="postcards-grid"></div>
        </div>

        <div class="screen" id="postcards">
            <h1>üìÆ –§–æ—Ç–æ-–∫–æ–ª–ª–∞–∂</h1>
            <div style="margin-bottom: 20px;">
                <label class="btn" style="display: block; text-align: center;">
                    üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                    <input type="file" id="imageUpload" accept="image/*" onchange="uploadPostcard(event)" style="display: none;">
                </label>
            </div>
            <div class="postcards-grid" id="postcardsGrid"></div>
        </div>

        <div class="screen" id="holidays">
            <h1>üìÖ –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ –ú–∏—Ä–∞</h1>
            <h3 style="margin-bottom: 15px;">–ë–ª–∏–∂–∞–π—à–∏–µ –ü—Ä–∞–∑–¥–Ω–∏–∫–∏</h3>
            <div id="upcomingHolidaysList" style="display: flex; flex-direction: column; gap: 0;">
                <p style="color:#999; text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞—Ö...</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" id="loadMoreHolidaysBtn" onclick="loadMoreHolidays()" style="width: 200px; display: none; background: #17a2b8;">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ 50
                </button>
            </div>
        </div>
    </div>
</div>

<div id="holidayPopup">
    <button class="popup-close" onclick="document.getElementById('holidayPopup').style.display='none'">√ó</button> 
</div>

<div id="fullscreenImageOverlay" onclick="this.style.display='none'">
    <button class="popup-close" onclick="document.getElementById('fullscreenImageOverlay').style.display='none'">√ó</button>
    <img id="fullImageView" src="" alt="Full size image">
</div>

<nav class="bottom-nav">
    <button class="nav-tab active" onclick="switchScreen('home')"><span class="nav-tab-icon">üìä</span>–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="nav-tab" onclick="switchScreen('chat')">
        <span class="nav-tab-icon">üí¨</span>–ß–∞—Ç <span class="badge" id="badge-chat-mob">0</span>
    </button>
    <button class="nav-tab" onclick="switchScreen('wall')">
        <span class="nav-tab-icon">üé®</span>–°—Ç–µ–Ω–∞ <span class="badge" id="badge-wall-mob">0</span>
    </button>
    <button class="nav-tab" onclick="switchScreen('postcards')">
        <span class="nav-tab-icon">üìÆ</span>–§–æ—Ç–æ <span class="badge" id="badge-foto-mob">0</span>
    </button>
    <button class="nav-tab" onclick="switchScreen('holidays')"><span class="nav-tab-icon">üìÖ</span>–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button> 
</nav>

<script>
    // ===== –ö–û–ù–§–ò–ì FIREBASE (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –°–í–û–ò –ö–õ–Æ–ß–ò!) =====
    const firebaseConfig = {
      apiKey: "AIzaSyA2KdD09QtBYIbFJKvCFMON6A--IxG2MXk",
      authDomain: "peop-3.firebaseapp.com",
      databaseURL: "https://peop-3-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "peop-3",
      storageBucket: "peop-3.firebasestorage.app",
      messagingSenderId: "293847601602",
      appId: "1:293847601602:web:9ad16928d4c1003b5a465b",
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    const SETTINGS = {
        meetingDate: '2024-06-24', 
        p1Name: '–°—É—Ä–∏–∫–∞—Ç', p1Birth: '2000-08-12',
        p2Name: '–ö–æ—Ç',     p2Birth: '2000-03-18'
    };

    let currentUser = localStorage.getItem('currentUser');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–¥–ª—è –±–µ–π–¥–∂–µ–π)
    let lastViewed = {
        chat: localStorage.getItem('lastViewed_chat') || 0,
        wall: localStorage.getItem('lastViewed_wall') || 0,
        postcards: localStorage.getItem('lastViewed_postcards') || 0
    };
    
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    let globalStats = {
        chat: { surikat: 0, kot: 0 },
        postcards: { surikat: 0, kot: 0 },
        wall: { surikat: 0, kot: 0 }
    };

    let undoStack = []; 
    let isDrawing = false; 
    let lastX = 0; let lastY = 0; const MAX_UNDO_STEPS = 20;

    const today = new Date(); today.setHours(0, 0, 0, 0); 
    const MONTHS = ['–Ø–Ω–≤–∞—Ä—è', '–§–µ–≤—Ä–∞–ª—è', '–ú–∞—Ä—Ç–∞', '–ê–ø—Ä–µ–ª—è', '–ú–∞—è', '–ò—é–Ω—è', '–ò—é–ª—è', '–ê–≤–≥—É—Å—Ç–∞', '–°–µ–Ω—Ç—è–±—Ä—è', '–û–∫—Ç—è–±—Ä—è', '–ù–æ—è–±—Ä—è', '–î–µ–∫–∞–±—Ä—è'];
    const HOLIDAY_DATA_BASE = []; 

    // === –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===
    function checkAuth() {
        if (currentUser) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            updateCounters(); 
        }
    }

    function doLogin() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value.trim().toLowerCase();
        
        if (p === 'kot') {
            currentUser = u === 'kot' ? '–ö–æ—Ç' : '–°—É—Ä–∏–∫–∞—Ç';
            localStorage.setItem('currentUser', currentUser);
            checkAuth();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }
    
    function doLogout() {
        currentUser = null; localStorage.removeItem('currentUser');
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('loginPass').value = ''; 
    }

    checkAuth();

    // === –ß–ê–¢ + –°–¢–ê–¢–ò–°–¢–ò–ö–ê + –ë–ï–ô–î–ñ–ò ===
    db.ref('chat').limitToLast(100).on('value', (snapshot) => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        // –°–±—Ä–æ—Å —Å—Ç–∞—Ç—ã —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞
        globalStats.chat = { surikat: 0, kot: 0 };
        let unreadCount = 0;

        snapshot.forEach((child) => {
            const msg = child.val();
            const key = child.key;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if (msg.user === '–°—É—Ä–∏–∫–∞—Ç') globalStats.chat.surikat++;
            if (msg.user === '–ö–æ—Ç') globalStats.chat.kot++;

            // –ë–µ–π–¥–∂–∏ (—Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —á—É–∂–∏–µ –∏ –Ω–æ–≤—ã–µ)
            if (msg.user !== currentUser && msg.timestamp > lastViewed.chat) {
                unreadCount++;
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50, —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å DOM)
            // –ù–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—á–∏—Ç–∞–µ–º –ø–æ 100
            // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ª—É—á—à–µ —Ä–∞–∑–¥–µ–ª—è—Ç—å "–∑–∞–≥—Ä—É–∑–∫—É –∏—Å—Ç–æ—Ä–∏–∏" –∏ "–ø–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
            const isMe = msg.user === currentUser; 
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            const deleteBtn = isMe ? `<button class="delete-msg" onclick="deleteMessage('${key}')">√ó</button>` : '';
            const userLabel = !isMe ? `<div style="font-size:10px; color:#aaa; margin-bottom:2px; margin-left: 2px;">${msg.user || '–ê–Ω–æ–Ω–∏–º'}</div>` : '';

            div.innerHTML = `<div style="max-width: 100%;">${userLabel}<div class="message-bubble">${deleteBtn}${msg.text}</div></div>`;
            messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        updateStatsUI();
        updateBadgeUI('chat', unreadCount);
    });

    // === –û–¢–ö–†–´–¢–ö–ò + –°–¢–ê–¢–ò–°–¢–ò–ö–ê + –ë–ï–ô–î–ñ–ò ===
    db.ref('postcards').on('value', (snapshot) => {
        const grid = document.getElementById('postcardsGrid');
        grid.innerHTML = '';
        
        globalStats.postcards = { surikat: 0, kot: 0 };
        let unreadCount = 0;

        snapshot.forEach((child) => {
            const data = child.val();
            const key = child.key;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if (data.user === '–°—É—Ä–∏–∫–∞—Ç') globalStats.postcards.surikat++;
            if (data.user === '–ö–æ—Ç') globalStats.postcards.kot++;

            // –ë–µ–π–¥–∂–∏
            if (data.user !== currentUser && data.timestamp > lastViewed.postcards) {
                unreadCount++;
            }

            const canDelete = (data.user === currentUser); 
            grid.innerHTML += `
                <div class="postcard">
                    <img src="${data.src}" onclick="showFullImage('${data.src}')">
                    ${canDelete ? `<button class="delete-card" onclick="deleteItem('postcards', '${key}', '${data.user}')">üóë</button>` : ''}
                    ${data.user ? `<div class="author-label">${data.user}</div>` : ''}
                </div>`;
        });
        updateStatsUI();
        updateBadgeUI('foto', unreadCount);
    });

    // === –ì–ê–õ–ï–†–ï–Ø –°–¢–ï–ù–´ + –°–¢–ê–¢–ò–°–¢–ò–ö–ê + –ë–ï–ô–î–ñ–ò ===
    db.ref('wall_gallery').on('value', (snapshot) => {
        const grid = document.getElementById('wallGalleryGrid');
        grid.innerHTML = '';
        
        globalStats.wall = { surikat: 0, kot: 0 };
        let unreadCount = 0;

        if (!snapshot.exists()) {
            grid.innerHTML = '<div style="color:#999; grid-column: 1/-1; text-align:center;">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</div>';
        } else {
            snapshot.forEach((child) => {
                const data = child.val();
                const key = child.key;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                if (data.user === '–°—É—Ä–∏–∫–∞—Ç') globalStats.wall.surikat++;
                if (data.user === '–ö–æ—Ç') globalStats.wall.kot++;

                // –ë–µ–π–¥–∂–∏
                if (data.user !== currentUser && data.timestamp > lastViewed.wall) {
                    unreadCount++;
                }

                const isMine = data.user === currentUser;
                grid.innerHTML += `
                    <div class="postcard">
                        <img src="${data.src}" onclick="showFullImage('${data.src}')">
                        ${isMine ? `<button class="delete-card" onclick="deleteItem('wall_gallery', '${key}', '${data.user}')">üóë</button>` : ''}
                        <div class="author-label">${data.user}</div>
                    </div>`;
            });
        }
        updateStatsUI();
        updateBadgeUI('wall', unreadCount);
    });

    // === –§–£–ù–ö–¶–ò–ò –û–ë–ù–û–í–õ–ï–ù–ò–Ø UI ===

    function updateBadgeUI(type, count) {
        // type: 'chat', 'wall', 'foto'
        const deskBadge = document.getElementById(`badge-${type}-desk`);
        const mobBadge = document.getElementById(`badge-${type}-mob`);
        
        if (count > 0) {
            deskBadge.innerText = count; deskBadge.style.display = 'inline-block';
            mobBadge.innerText = count; mobBadge.style.display = 'inline-block';
        } else {
            deskBadge.style.display = 'none';
            mobBadge.style.display = 'none';
        }
    }

    function updateStatsUI() {
        function setBar(id1, id2, val1, val2) {
            const el1 = document.getElementById(id1);
            const el2 = document.getElementById(id2);
            const total = val1 + val2;
            
            if (total === 0) {
                el1.style.width = '50%'; el2.style.width = '50%'; // –ü–æ—Ä–æ–≤–Ω—É –µ—Å–ª–∏ –Ω—É–ª–∏
            } else {
                const p1 = (val1 / total) * 100;
                el1.style.width = p1 + '%';
                el2.style.width = (100 - p1) + '%';
            }
        }
        
        // –ß–∞—Ç
        document.getElementById('stat-chat-1').innerText = globalStats.chat.surikat;
        document.getElementById('stat-chat-2').innerText = globalStats.chat.kot;
        setBar('bar-chat-1', 'bar-chat-2', globalStats.chat.surikat, globalStats.chat.kot);

        // –§–æ—Ç–æ
        document.getElementById('stat-foto-1').innerText = globalStats.postcards.surikat;
        document.getElementById('stat-foto-2').innerText = globalStats.postcards.kot;
        setBar('bar-foto-1', 'bar-foto-2', globalStats.postcards.surikat, globalStats.postcards.kot);

        // –°—Ç–µ–Ω–∞
        document.getElementById('stat-wall-1').innerText = globalStats.wall.surikat;
        document.getElementById('stat-wall-2').innerText = globalStats.wall.kot;
        setBar('bar-wall-1', 'bar-wall-2', globalStats.wall.surikat, globalStats.wall.kot);
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-tab, .nav-item').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`[onclick="switchScreen('${id}')"]`).forEach(t => t.classList.add('active'));
        
        // –°–±—Ä–æ—Å –±–µ–π–¥–∂–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        if (id === 'chat' || id === 'wall' || id === 'postcards') {
            lastViewed[id] = Date.now();
            localStorage.setItem(`lastViewed_${id}`, lastViewed[id]);
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç—å –±–µ–π–¥–∂ —Å—Ä–∞–∑—É (—Ö–æ—Ç—è .on('value') —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–∑–∂–µ, —ç—Ç–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Ä–µ–∞–∫—Ü–∏–∏)
            let type = id === 'postcards' ? 'foto' : id;
            document.getElementById(`badge-${type}-desk`).style.display = 'none';
            document.getElementById(`badge-${type}-mob`).style.display = 'none';
        }

        if(id === 'wall') setTimeout(resizeCanvas, 100);
    }

    // === –î–†–£–ì–ò–ï –§–£–ù–ö–¶–ò–ò (–î–ê–¢–´, –¶–ï–õ–ò, CANVAS) ===

    function renderList(node, containerId, color) {
        db.ref(node).on('value', (snapshot) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            snapshot.forEach((child) => {
                const item = child.val();
                const key = child.key;
                const today = new Date(); today.setHours(0,0,0,0);
                const target = new Date(item.date); target.setHours(0,0,0,0);
                const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                const daysText = diff >= 0 ? `${diff} –¥–Ω.` : '–ü—Ä–æ—à–ª–æ';
                container.innerHTML += `
                    <div class="compact-item-card" style="border-left: 4px solid ${color};">
                        <button onclick="deleteItem('${node}', '${key}', '${currentUser}')">√ó</button>
                        <div style="font-size:16px; font-weight:700; color:#333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                        <div style="font-size:11px; color:${color}; margin-top:5px;">${new Date(item.date).toLocaleDateString('ru-RU')}</div>
                        <div style="font-size:11px; color:#999; margin-top: 2px;">${daysText}</div>
                    </div>`;
            });
        });
    }
    renderList('importantDates', 'importantDatesContainer', '#FF9800');
    renderList('goals', 'goalsContainer', '#4CAF50');

    // Canvas
    let canvas = document.getElementById('drawingCanvas'); let ctx = canvas.getContext('2d');
    function redrawCanvas(dataUrl) {
        if (dataUrl) {
            const img = new Image();
            img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
            img.src = dataUrl;
        } else { ctx.clearRect(0, 0, canvas.width, canvas.height); }
    }
    db.ref('wall').on('value', (snapshot) => {
        const dataUrl = snapshot.val();
        if (dataUrl && undoStack.length === 0) { redrawCanvas(dataUrl); undoStack.push(dataUrl); } 
        else if (!dataUrl) { ctx.clearRect(0,0, canvas.width, canvas.height); undoStack = []; }
    });

    // –¢–∞–π–º–µ—Ä—ã
    function updateCounters() {
        const start = new Date(SETTINGS.meetingDate); const now = new Date(); const diff = now - start;
        document.getElementById('daysDisplay').innerText = Math.floor(diff / (1000 * 60 * 60 * 24));
        document.getElementById('hoursDisplay').innerText = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        document.getElementById('minutesDisplay').innerText = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        document.getElementById('secondsDisplay').innerText = Math.floor((diff % (1000 * 60)) / 1000); 
        document.getElementById('daysTogetherDisplay').innerText = Math.floor(diff / (1000 * 60 * 60 * 24)) + ' –¥–Ω–µ–π';
        calcBirthday(SETTINGS.p1Birth, 'daysToP1'); calcBirthday(SETTINGS.p2Birth, 'daysToP2');
    }
    function calcBirthday(dateStr, elemId) {
        if (!dateStr) return;
        const today = new Date(); today.setHours(0, 0, 0, 0); const bday = new Date(dateStr);
        let nextBday = new Date(today.getFullYear(), bday.getMonth(), bday.getDate());
        if (today.getTime() > nextBday.getTime()) nextBday.setFullYear(today.getFullYear() + 1);
        document.getElementById(elemId).innerText = Math.ceil((nextBday - today) / (1000 * 60 * 60 * 24)) + ' –¥–Ω.';
    }
    setInterval(updateCounters, 1000);

    // –î–µ–π—Å—Ç–≤–∏—è
    function sendMessage() {
        const input = document.getElementById('chatInput'); const text = input.value.trim();
        if (text) { db.ref('chat').push({ text: text, user: currentUser, timestamp: Date.now() }); input.value = ''; }
    }
    function deleteMessage(key) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.ref('chat').child(key).remove(); }
    function addImportantDate() {
        const name = document.getElementById('impName').value; const date = document.getElementById('impDate').value;
        if (name && date) { db.ref('importantDates').push({ name, date, user: currentUser, timestamp: Date.now() }); document.getElementById('impName').value=''; document.getElementById('impDate').value=''; }
    }
    function addGoal() {
        const name = document.getElementById('goalName').value; const date = document.getElementById('goalDate').value;
        if (name && date) { db.ref('goals').push({ name, date, user: currentUser, timestamp: Date.now() }); document.getElementById('goalName').value=''; document.getElementById('goalDate').value=''; }
    }
    function deleteItem(node, key, author) { 
        if(author !== currentUser) { alert('–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏.'); return; }
        if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.ref(node).child(key).remove(); 
    }

    // Canvas Events
    function resizeCanvas() { const c = document.getElementById('drawingCanvasContainer'); if (!c) return; canvas.width = c.clientWidth; canvas.height = c.clientHeight; if (undoStack.length > 0) redrawCanvas(undoStack[undoStack.length - 1]); }
    window.addEventListener('load', resizeCanvas); window.addEventListener('resize', resizeCanvas);
    function getPos(e) { const r = canvas.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; return { x: (cx - r.left) * (canvas.width / r.width), y: (cy - r.top) * (canvas.height / r.height) }; }
    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchmove', draw, {passive: false});
    canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('touchend', stopDraw);
    function startDraw(e) { if(e.type==='touchstart') e.preventDefault(); isDrawing=true; const p=getPos(e); lastX=p.x; lastY=p.y; }
    function draw(e) { if (!isDrawing) return; if(e.type==='touchmove') e.preventDefault(); const p = getPos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.strokeStyle = document.getElementById('colorPicker').value; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.stroke(); lastX = p.x; lastY = p.y; }
    function stopDraw() { if (isDrawing) { isDrawing = false; undoStack.push(canvas.toDataURL()); if(undoStack.length>MAX_UNDO_STEPS) undoStack.shift(); db.ref('wall').set(undoStack[undoStack.length-1]); } }
    function undoWallDrawing() { if (undoStack.length > 1) { undoStack.pop(); const p = undoStack[undoStack.length - 1]; redrawCanvas(p); db.ref('wall').set(p); } else { ctx.clearRect(0,0, canvas.width, canvas.height); undoStack=[]; db.ref('wall').set(null); } }
    function clearCanvas() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å?')) { ctx.clearRect(0,0, canvas.width, canvas.height); undoStack=[]; db.ref('wall').set(null); } }
    function saveWallDrawing() { if(confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –≥–∞–ª–µ—Ä–µ—é?')) { db.ref('wall_gallery').push({ src: canvas.toDataURL(), user: currentUser, timestamp: Date.now() }); } }
    
    // Upload
    function uploadPostcard(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = (e) => {
            const img = new Image(); img.onload = () => {
                const c = document.createElement('canvas'); let w = img.width, h = img.height, max = 800;
                if (w > max || h > max) { const r = Math.min(max/w, max/h); w*=r; h*=r; }
                c.width = w; c.height = h; c.getContext('2d').drawImage(img, 0, 0, w, h);
                db.ref('postcards').push({ src: c.toDataURL('image/jpeg', 0.8), user: currentUser, timestamp: Date.now() });
                alert('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
            }; img.src = e.target.result;
        }; reader.readAsDataURL(file);
    }
    function showFullImage(src) { document.getElementById('fullImageView').src = src; document.getElementById('fullscreenImageOverlay').style.display = 'flex'; }
    function loadMoreHolidays() { /* –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ */ }
</script>
</body>
</html>
