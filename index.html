<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="PWA –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞—Å">
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232196F3' width='192' height='192'/><text x='96' y='120' font-size='120' fill='white' text-anchor='middle' font-weight='bold'>üíï</text></svg>">
    <link rel="manifest" href='data:application/json,{"name": "–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è", "short_name": "–ò—Å—Ç–æ—Ä–∏—è", "description": "–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "start_url": "/", "display": "standalone", "background_color": "#ffffff", "theme_color": "#2196F3", "icons": [{"src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 192 192%22><rect fill=%22%232196F3%22 width=%22192%22 height=%22192%22/><text x=%2296%22 y=%22120%22 font-size=%22120%22 fill=%22white%22 text-anchor=%22middle%22 font-weight=%22bold%22>üíï</text></svg>", "sizes": "192x192", "type": "image/svg+xml", "purpose": "any"}]}'>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            /* –§–æ–Ω —Å –∫–æ—Ç–∏–∫–∞–º–∏ –∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º */
            background-color: #f0f4f8;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 25 Q 15 10 25 18 L 30 18 L 35 18 Q 45 10 45 25 Q 50 35 30 45 Q 10 35 15 25 Z' fill='none' stroke='%232196F3' stroke-opacity='0.15' stroke-width='2'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #f0f4f8 0%, #e8f1f7 100%);
            background-size: 60px 60px, cover;
            color: #1a1a1a; 
            overflow-x: hidden; 
            touch-action: manipulation; 
        }

        .container { display: flex; min-height: 100vh; }
        
        /* Sidebar (Desktop) */
        .sidebar { display: none; width: 280px; background: white; border-right: 1px solid #d0dce7; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; font-size: 24px; color: #2196F3; font-weight: bold; }
        .nav-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #666; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px;}
        .nav-item:hover, .nav-item.active { background: #e3f2fd; color: #2196F3; }
        
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .screen { display: none; padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .screen.active { display: block; }
        
        @media (min-width: 1024px) { .sidebar { display: block; } .main-content { margin-left: 280px; } .bottom-nav { display: none !important; } }
        
        /* Cards */
        .cards-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        
        /* Timer Grid */
        .timer-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            margin-bottom: 24px; 
        }
        @media (min-width: 600px) {
            .timer-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 16px; 
            box-shadow: 0 2px 8px rgba(33,150,243,0.08); 
            text-align: center; 
            border: 1px solid #e3f2fd; 
            position: relative; 
            /* –î–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π/–¥–∞—Ç */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .card-value { font-size: 28px; font-weight: 700; color: #2196F3; }
        .card-label { font-size: 12px; color: #999; text-transform: uppercase; margin-top: 4px; letter-spacing: 0.5px;}

        /* –ö–û–ú–ü–ê–ö–¢–ù–´–ô –ì–†–ò–î –¥–ª—è –î–∞—Ç –∏ –¶–µ–ª–µ–π */
        #importantDatesGrid, #goalsCompactGrid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Chat */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 180px); }
        .messages { flex: 1; overflow-y: auto; margin-bottom: 16px; display: flex; flex-direction: column; gap: 10px; padding: 10px; }
        .message { display: flex; max-width: 85%; position: relative; }
        .message.sent { align-self: flex-end; justify-content: flex-end; margin-left: auto; }
        .message-bubble { 
            padding: 10px 14px; 
            border-radius: 16px; 
            font-size: 14px; 
            word-wrap: break-word; 
            position: relative; 
        }
        /* –ö–û–ù–¢–†–ê–°–¢–ù–´–ï –û–ë–õ–ê–ß–ö–ê */
        .message.sent .message-bubble { 
            background: #007bff; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Å–∏–Ω–∏–π */
            color: white; 
            border-bottom-right-radius: 2px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); /* –¢–µ–Ω—å –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
        }
        .message.received .message-bubble { 
            background: #ffffff; /* –ë–µ–ª—ã–π —Ñ–æ–Ω */
            color: #1a1a1a; /* –ß–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
            border: 1px solid #ddd;
            border-bottom-left-radius: 2px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .delete-msg { position: absolute; top: -8px; left: -8px; background: #ff4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; border: none; cursor: pointer; display: none; justify-content: center; align-items: center; z-index: 10;}
        .message:hover .delete-msg { display: flex; }

        .chat-input-group { display: flex; gap: 8px; padding-top: 10px; border-top: 1px solid #eee; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; background: #2196F3; color: white; border: none; cursor: pointer; }
        
        /* Wall */
        #drawingCanvas { border: 2px solid #d0dce7; border-radius: 12px; background: white; touch-action: none; width: 100%; max-width: 600px; margin: 0 auto; display: block; cursor: crosshair; }
        
        /* Postcards (Collage Style) */
        .postcards-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 25px; 
            padding: 10px;
        }
        
        .postcard { 
            position: relative; 
            aspect-ratio: 3/4; 
            background: white; 
            padding: 0; 
            box-shadow: 3px 3px 10px rgba(0,0,0,0.15); 
            border-radius: 2px; 
            overflow: visible; 
            border: 6px solid white; 
            border-bottom: 25px solid white; 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27);
        }

        .postcard img { width: 100%; height: 100%; object-fit: cover; border-radius: 0; }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ */
        .postcard:nth-child(odd) { transform: rotate(-3deg); }
        .postcard:nth-child(even) { transform: rotate(2deg); }
        .postcard:nth-child(3n) { transform: rotate(4deg); }
        .postcard:nth-child(4n) { transform: rotate(-5deg); }

        .postcard:hover {
            transform: scale(1.05) rotate(0deg) !important;
            z-index: 100;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .delete-card { position: absolute; top: -15px; right: -15px; background: rgba(255, 68, 68, 1); color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 5; }
        .author-label { position: absolute; bottom: -20px; left: 0; right: 0; color: #666; font-size: 11px; padding: 2px 5px; text-align: center; font-family: cursive; }

        /* Controls */
        .btn { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 5px; }
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; }
        
        /* Bottom Nav */
        .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; height: 60px; z-index: 1000; justify-content: space-around; align-items: center; }
        .nav-tab { background: none; border: none; color: #999; font-size: 11px; display: flex; flex-direction: column; align-items: center; }
        .nav-tab.active { color: #2196F3; }
        .nav-tab-icon { font-size: 20px; margin-bottom: 2px; }
        
        /* Login Screen */
        #loginScreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #loginError { color: red; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div id="loginScreen">
    <h1 style="color: #2196F3; margin-bottom: 20px;">üíï –ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</h1>
    <div style="width: 100%; max-width: 300px;">
        <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">–ö—Ç–æ —Ç—ã?</label>
        <select id="loginUser">
            <option value="surikat">–°—É—Ä–∏–∫–∞—Ç</option>
            <option value="kot">–ö–æ—Ç</option>
        </select>
        
        <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <div id="loginError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
</div>

<div class="container" id="appContainer" style="display:none;">
    <nav class="sidebar">
        <div class="sidebar-header">üíï –ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="sidebar-nav">
            <button class="nav-item active" onclick="switchScreen('home')">üìä –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="nav-item" onclick="switchScreen('chat')">üí¨ –ß–∞—Ç</button>
            <button class="nav-item" onclick="switchScreen('wall')">üé® –°—Ç–µ–Ω–∞</button>
            <button class="nav-item" onclick="switchScreen('postcards')">üìÆ –û—Ç–∫—Ä—ã—Ç–∫–∏</button>
            <div style="flex: 1"></div>
            <button class="nav-item" onclick="doLogout()" style="color: #ff4444; border-top: 1px solid #eee;">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </nav>

    <div class="main-content">
        <div class="screen active" id="home">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1 style="font-size: 24px; margin-bottom: 5px;">–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</h1>
                    <p style="color: #666;">–í–º–µ—Å—Ç–µ —É–∂–µ <strong id="daysTogetherDisplay">...</strong></p>
                </div>
                <button class="btn" style="width: auto; background: #ff4444; padding: 5px 12px; font-size: 13px;" onclick="doLogout()">–í—ã–π—Ç–∏</button>
            </div>
            
            <div class="timer-grid">
                <div class="card">
                    <div class="card-value" id="daysDisplay">0</div>
                    <div class="card-label">–î–Ω–µ–π</div>
                </div>
                <div class="card">
                    <div class="card-value" id="hoursDisplay">0</div>
                    <div class="card-label">–ß–∞—Å–æ–≤</div>
                </div>
                <div class="card">
                    <div class="card-value" id="minutesDisplay">0</div>
                    <div class="card-label">–ú–∏–Ω—É—Ç</div>
                </div>
                <div class="card">
                    <div class="card-value" id="secondsDisplay">0</div>
                    <div class="card-label">–°–µ–∫—É–Ω–¥</div>
                </div>
            </div>

            <h2 style="font-size: 18px; margin: 24px 0 10px;">–î–æ –î–Ω—è –†–æ–∂–¥–µ–Ω–∏—è</h2>
            <div class="cards-grid">
                <div class="card"><div class="card-value" id="daysToP1">...</div><div class="card-label">–°—É—Ä–∏–∫–∞—Ç (12.08)</div></div>
                <div class="card"><div class="card-value" id="daysToP2">...</div><div class="card-label">–ö–æ—Ç (18.03)</div></div>
            </div>

            <h2 style="font-size: 18px; margin: 24px 0 10px;">–í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã</h2>
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e3f2fd;">
                <input type="text" id="impName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è">
                <input type="date" id="impDate">
                <button class="btn" onclick="addImportantDate()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É</button>
            </div>
            <div id="importantDatesGrid"></div>

            <h2 style="font-size: 18px; margin: 24px 0 10px;">üéØ –¶–µ–ª–∏</h2>
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e3f2fd;">
                <input type="text" id="goalName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏">
                <input type="date" id="goalDate">
                <button class="btn" onclick="addGoal()">‚ú® –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</button>
            </div>
            <div id="goalsCompactGrid"></div>
        </div>

        <div class="screen" id="chat">
            <h1>üí¨ –ß–∞—Ç</h1>
            <div class="chat-container">
                <div class="messages" id="messages"></div>
                <div class="chat-input-group">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <div class="screen" id="wall">
            <h1>üé® –†–∏—Å—É–µ–º –≤–º–µ—Å—Ç–µ</h1>
            <canvas id="drawingCanvas" height="400"></canvas>
            
            <div style="margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <span style="font-size: 11px; color: #666; margin-bottom: 4px;">–¶–≤–µ—Ç</span>
                    <input type="color" id="colorPicker" value="#000000" style="width: 40px; height: 35px; padding: 0; border: none; background: none;">
                </div>
                
                <button class="btn" style="width: auto; height: 35px; margin-top: 0; background: #607d8b;" onclick="undoWallDrawing()">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å</button>
                
                <button class="btn" style="width: auto; height: 35px; margin-top: 0;" onclick="clearCanvas()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn" style="width: auto; height: 35px; margin-top: 0;" onclick="saveWallDrawing()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            
            <h2 style="font-size: 18px; margin: 30px 0 15px;">–ì–∞–ª–µ—Ä–µ—è —Ä–∏—Å—É–Ω–∫–æ–≤</h2>
            <div id="wallGalleryGrid" class="postcards-grid"></div>
        </div>

        <div class="screen" id="postcards">
            <h1>üìÆ –§–æ—Ç–æ-–∫–æ–ª–ª–∞–∂</h1>
            <div style="margin-bottom: 20px;">
                <label class="btn" style="display: block; text-align: center;">
                    üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                    <input type="file" id="imageUpload" accept="image/*" onchange="uploadPostcard(event)" style="display: none;">
                </label>
            </div>
            <div class="postcards-grid" id="postcardsGrid"></div>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-tab active" onclick="switchScreen('home')"><span class="nav-tab-icon">üìä</span>–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="nav-tab" onclick="switchScreen('chat')"><span class="nav-tab-icon">üí¨</span>–ß–∞—Ç</button>
    <button class="nav-tab" onclick="switchScreen('wall')"><span class="nav-tab-icon">üé®</span>–°—Ç–µ–Ω–∞</button>
    <button class="nav-tab" onclick="switchScreen('postcards')"><span class="nav-tab-icon">üìÆ</span>–§–æ—Ç–æ</button>
</nav>

<script>
    // ===== –ö–û–ù–§–ò–ì FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyA2KdD09QtBYIbFJKvCFMON6A--IxG2MXk",
      authDomain: "peop-3.firebaseapp.com",
      databaseURL: "https://peop-3-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "peop-3",
      storageBucket: "peop-3.firebasestorage.app",
      messagingSenderId: "293847601602",
      appId: "1:293847601602:web:9ad16928d4c1003b5a465b",
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    const SETTINGS = {
        meetingDate: '2024-06-24',
        p1Name: '–°—É—Ä–∏–∫–∞—Ç', p1Birth: '2000-08-12',
        p2Name: '–ö–æ—Ç',     p2Birth: '2000-03-18'
    };

    let currentUser = localStorage.getItem('currentUser');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    const MAX_UNDO_STEPS = 20;
    let undoStack = []; 
    let isDrawing = false; 
    let lastX = 0; 
    let lastY = 0;

    // ===== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø =====
    function checkAuth() {
        if (currentUser) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            updateCounters(); 
        }
    }

    function doLogin() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value.trim();
        
        let role = null;
        
        // –ü–∞—Ä–æ–ª—å –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É "kot" –¥–ª—è –æ–±–æ–∏—Ö
        if (u === 'kot' && p.toLowerCase() === 'kot') role = '–ö–æ—Ç';
        if (u === 'surikat' && p.toLowerCase() === 'kot') role = '–°—É—Ä–∏–∫–∞—Ç';

        if (role) {
            currentUser = role;
            localStorage.setItem('currentUser', role);
            checkAuth();
        } else {
            document.getElementById('loginError').style.display = 'block';
            document.getElementById('loginError').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
        }
    }
    
    // –§–£–ù–ö–¶–ò–Ø –í–´–•–û–î–ê
    function doLogout() {
        if(confirm('–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?')) {
            localStorage.removeItem('currentUser');
            location.reload();
        }
    }
    
    checkAuth();


    // ===== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –£–î–ê–õ–ï–ù–ò–Ø =====
    
    // –ß–∞—Ç
    db.ref('chat').limitToLast(50).on('value', (snapshot) => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        snapshot.forEach((child) => {
            const msg = child.val();
            const key = child.key;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–≤–µ–Ω —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const isMe = msg.user === currentUser; 
            const canDelete = isMe; // –£–¥–∞–ª—è—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä
            
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            
            // –ï—Å–ª–∏ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            const deleteBtn = canDelete ? `<button class="delete-msg" onclick="deleteMessage('${key}')">√ó</button>` : '';
            const userLabel = `<div style="font-size:10px; color:#aaa; margin-bottom:2px;">${msg.user || '–ê–Ω–æ–Ω–∏–º'}</div>`;

            div.innerHTML = `
                <div>
                    ${!isMe ? userLabel : ''}
                    <div class="message-bubble">
                        ${deleteBtn}
                        ${msg.text}
                    </div>
                </div>
            `;
            messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // –û—Ç–∫—Ä—ã—Ç–∫–∏
    db.ref('postcards').on('value', (snapshot) => {
        const grid = document.getElementById('postcardsGrid');
        grid.innerHTML = '';
        snapshot.forEach((child) => {
            const data = child.val();
            const key = child.key;
            
            const src = typeof data === 'object' ? data.src : data;
            const user = typeof data === 'object' ? data.user : null;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–≤–µ–Ω —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const canDelete = (user === currentUser); 

            // –ï—Å–ª–∏ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            const deleteBtn = canDelete ? `<button class="delete-card" onclick="deleteItem('postcards', '${key}', '${user}')">üóë</button>` : '';
            const authorLabel = user ? `<div class="author-label">${user}</div>` : '';

            grid.innerHTML += `
                <div class="postcard">
                    <img src="${src}" onclick="alert('–û—Ç–∫—Ä—ã—Ç–∫–∞ –æ—Ç ${user || '–ê–Ω–æ–Ω–∏–º–∞'}')">
                    ${deleteBtn}
                    ${authorLabel}
                </div>`;
        });
    });

    // –ì–∞–ª–µ—Ä–µ—è –°—Ç–µ–Ω—ã (–†–∏—Å—É–Ω–∫–∏)
    db.ref('wall_gallery').on('value', (snapshot) => {
        const grid = document.getElementById('wallGalleryGrid');
        grid.innerHTML = '';
        if (!snapshot.exists()) {
            grid.innerHTML = '<div style="color:#999; grid-column: 1/-1; text-align:center;">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞—Ä–∏—Å—É–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"!</div>';
            return;
        }
        
        snapshot.forEach((child) => {
            const data = child.val();
            const key = child.key;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–≤–µ–Ω —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const isMine = data.user === currentUser;
            const deleteBtn = isMine ? `<button class="delete-card" onclick="deleteItem('wall_gallery', '${key}', '${data.user}')">üóë</button>` : '';

            grid.innerHTML += `
                <div class="postcard">
                    <img src="${data.src}">
                    ${deleteBtn}
                    <div class="author-label">${data.user}</div>
                </div>`;
        });
    });

    // –í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã (–ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
    db.ref('importantDates').on('value', (snapshot) => {
        const grid = document.getElementById('importantDatesGrid');
        grid.innerHTML = '';
        snapshot.forEach((child) => {
            const item = child.val();
            const key = child.key;
            const today = new Date();
            const target = new Date(item.date);
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            const daysText = diff >= 0 ? `${diff} –¥–Ω.` : '–ü—Ä–æ—à–ª–æ';
            grid.innerHTML += `
                <div class="card" style="position:relative; min-height: 80px;">
                    <button onclick="deleteItem('importantDates', '${key}', '${currentUser}')" style="position:absolute; right:5px; top:5px; border:none; background:none; color:red;">√ó</button>
                    <div style="font-size:18px; font-weight:700; color:#333;">${item.name}</div>
                    <div style="font-size:11px; color:#2196F3; margin-top:5px;">${new Date(item.date).toLocaleDateString('ru-RU')}</div>
                    <div style="font-size:11px; color:#999;">${daysText}</div>
                </div>`;
        });
    });

    // –¶–µ–ª–∏ (–ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
    db.ref('goals').on('value', (snapshot) => {
        const grid = document.getElementById('goalsCompactGrid');
        grid.innerHTML = '';
        snapshot.forEach((child) => {
            const goal = child.val();
            const key = child.key;
            const today = new Date();
            const target = new Date(goal.date);
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            const daysText = diff >= 0 ? `${diff} –¥–Ω.` : '–ü—Ä–æ—à–ª–æ';
            grid.innerHTML += `
                <div class="card" style="position:relative; min-height: 80px; border-left: 4px solid #2196F3;">
                    <button onclick="deleteItem('goals', '${key}', '${currentUser}')" style="position:absolute; right:5px; top:5px; border:none; background:none; color:red;">√ó</button>
                    <div style="font-size:18px; font-weight:700; color:#333;">${goal.name}</div>
                    <div style="font-size:11px; color:#2196F3; margin-top:5px;">${new Date(goal.date).toLocaleDateString('ru-RU')}</div>
                    <div style="font-size:11px; color:#999;">${daysText}</div>
                </div>`;
        });
    });

    // –°—Ç–µ–Ω–∞
    let canvas = document.getElementById('drawingCanvas');
    let ctx = canvas.getContext('2d');
    
    function resizeCanvas() { 
        const parent = canvas.parentElement; 
        const rect = parent.getBoundingClientRect();
        if (canvas.width !== rect.width) canvas.width = rect.width;
        if (canvas.height !== 400) canvas.height = 400;
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
        if (undoStack.length > 0) {
            redrawCanvas(undoStack[undoStack.length - 1]);
        }
    }
    window.addEventListener('resize', resizeCanvas);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ DataURL
    function redrawCanvas(dataUrl) {
        if (dataUrl) {
            const img = new Image();
            img.onload = () => {
                // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = dataUrl;
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    db.ref('wall').on('value', (snapshot) => {
        const dataUrl = snapshot.val();
        if (dataUrl && undoStack.length === 0) { // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–∞–∑—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
            redrawCanvas(dataUrl);
            undoStack.push(dataUrl); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        } else if (!dataUrl) {
             ctx.clearRect(0, 0, canvas.width, canvas.height);
             undoStack = [];
        }
    });
    // –í—ã–∑–æ–≤ resizeCanvas –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    window.addEventListener('load', resizeCanvas);

    // ===== –õ–û–ì–ò–ö–ê UI =====

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-tab, .nav-item').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`[onclick="switchScreen('${id}')"]`).forEach(t => t.classList.add('active'));
        if(id === 'wall') resizeCanvas();
    }

    // –¢–ê–ô–ú–ï–†–´
    function updateCounters() {
        const start = new Date(SETTINGS.meetingDate);
        const now = new Date();
        const diff = now - start;
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000); 
        
        document.getElementById('daysDisplay').innerText = days;
        document.getElementById('hoursDisplay').innerText = hours;
        document.getElementById('minutesDisplay').innerText = minutes;
        document.getElementById('secondsDisplay').innerText = seconds;
        document.getElementById('daysTogetherDisplay').innerText = days + ' –¥–Ω–µ–π';

        calcBirthday(SETTINGS.p1Birth, 'daysToP1');
        calcBirthday(SETTINGS.p2Birth, 'daysToP2');
    }

    function calcBirthday(dateStr, elemId) {
        if (!dateStr) return;
        const today = new Date();
        const bday = new Date(dateStr);
        let nextBday = new Date(today.getFullYear(), bday.getMonth(), bday.getDate());
        if (today > nextBday) nextBday.setFullYear(today.getFullYear() + 1);
        const daysLeft = Math.ceil((nextBday - today) / (1000 * 60 * 60 * 24));
        document.getElementById(elemId).innerText = daysLeft + ' –¥–Ω.';
    }

    setInterval(updateCounters, 1000);

    // ===== –î–ï–ô–°–¢–í–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø =====

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (text) {
            db.ref('chat').push({ 
                text: text, 
                user: currentUser, 
                timestamp: Date.now() 
            });
            input.value = '';
        }
    }

    function deleteMessage(key) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ on('value') –≤—ã—à–µ.
            // –ó–¥–µ—Å—å –º—ã –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Firebase (–µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã) 
            // –∏–ª–∏ –Ω–∞ —Ç–æ, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É.
            db.ref('chat').child(key).remove();
        }
    }

    function addImportantDate() {
        const name = document.getElementById('impName').value;
        const date = document.getElementById('impDate').value;
        if (name && date) {
            db.ref('importantDates').push({ name, date });
            document.getElementById('impName').value = '';
            document.getElementById('impDate').value = '';
        }
    }

    function addGoal() {
        const name = document.getElementById('goalName').value;
        const date = document.getElementById('goalDate').value;
        if (name && date) {
            db.ref('goals').push({ name, date });
            document.getElementById('goalName').value = '';
            document.getElementById('goalDate').value = '';
        }
    }
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    function deleteItem(node, key, itemAuthor) { 
        if(itemAuthor !== currentUser) {
            alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–±–∞–≤–∏–ª–∏ —Å–∞–º–∏.');
            return;
        }
        if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) db.ref(node).child(key).remove(); 
    }


    // –†–∏—Å–æ–≤–∞–Ω–∏–µ
    
    // –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–Ω–≤–∞—Å–∞ –≤ —Å—Ç–µ–∫ –æ—Ç–º–µ–Ω—ã
    function saveStateToUndoStack() {
        if (undoStack.length >= MAX_UNDO_STEPS) {
            undoStack.shift(); // –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π —à–∞–≥
        }
        undoStack.push(canvas.toDataURL());
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchend', stopDraw);
    canvas.addEventListener('mouseout', stopDraw); // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞

    function startDraw(e) { 
        isDrawing = true; 
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–π –ª–∏–Ω–∏–∏
        saveStateToUndoStack(); 
        const pos = getPos(e); 
        lastX = pos.x; lastY = pos.y; 
    }
    
    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.beginPath(); 
        ctx.moveTo(lastX, lastY); 
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = document.getElementById('colorPicker').value;
        ctx.lineWidth = 3; 
        ctx.lineCap = 'round'; 
        ctx.stroke();
        lastX = pos.x; lastY = pos.y;
    }
    
    function stopDraw() {
        if (isDrawing) {
            isDrawing = false;
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —à—Ç—Ä–∏—Ö–∞
            db.ref('wall').set(canvas.toDataURL('image/png'));
        }
    }
    
    function undoWallDrawing() {
        if (undoStack.length > 1) {
            undoStack.pop(); // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ) —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const previousState = undoStack[undoStack.length - 1]; // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–µ
            redrawCanvas(previousState);
            db.ref('wall').set(previousState); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        } else if (undoStack.length === 1) {
             // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —à–∞–≥ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–µ –ø—É—Å—Ç–æ–µ/–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
             ctx.clearRect(0,0, canvas.width, canvas.height); 
             undoStack = [];
             db.ref('wall').set(null);
        } else {
             alert('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å!');
        }
    }

    function clearCanvas() { 
        if(confirm('–°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë —Å –¥–æ—Å–∫–∏?')) { 
            ctx.clearRect(0,0, canvas.width, canvas.height); 
            undoStack = [];
            db.ref('wall').set(null); 
        } 
    }

    function saveWallDrawing() {
        if(confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –≤ –≥–∞–ª–µ—Ä–µ—é –ø–æ–¥ –¥–æ—Å–∫–æ–π?')) {
            const dataUrl = canvas.toDataURL(); 
            db.ref('wall_gallery').push({
                src: dataUrl,
                user: currentUser,
                timestamp: Date.now()
            }, (error) => {
                if(!error) alert('–†–∏—Å—É–Ω–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            });
        }
    }

    function uploadPostcard(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const tempCanvas = document.createElement('canvas');
                let width = img.width; let height = img.height;
                const maxSize = 600;
                if (width > maxSize) { height = height * (maxSize / width); width = maxSize; }
                tempCanvas.width = width; tempCanvas.height = height;
                const tCtx = tempCanvas.getContext('2d');
                tCtx.drawImage(img, 0, 0, width, height);
                
                db.ref('postcards').push({
                    src: tempCanvas.toDataURL('image/jpeg', 0.7),
                    user: currentUser,
                    timestamp: Date.now()
                });
                alert('–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>
