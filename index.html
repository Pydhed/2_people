<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="PWA –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞—Å">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- –ò–∫–æ–Ω–∫–∏ –∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ –∂–µ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232196F3' width='192' height='192'/><text x='96' y='120' font-size='120' fill='white' text-anchor='middle' font-weight='bold'>üíï</text></svg>">
    <link rel="manifest" href="data:application/json,{ 'name': '–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è', 'short_name': '–ò—Å—Ç–æ—Ä–∏—è', 'description': '–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', 'start_url': '/', 'display': 'standalone', 'background_color': '#ffffff', 'theme_color': '#2196F3', 'icons': [ {'src': 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 192 192%22><rect fill=%22%232196F3%22 width=%22192%22 height=%22192%22/><text x=%2296%22 y=%22120%22 font-size=%22120%22 fill=%22white%22 text-anchor=%22middle%22 font-weight=%22bold%22>üíï</text></svg>', 'sizes': '192x192', 'type': 'image/svg+xml', 'purpose': 'any'} ] }">

    <style>
        /* –í–ê–®–ò –°–¢–ò–õ–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô (—è –∏—Ö —Å–∂–∞–ª –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –æ–±—Ä–∞—Ç–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –º–µ–Ω—è—Ç—å) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: linear-gradient(135deg, #f0f4f8 0%, #e8f1f7 100%); color: #1a1a1a; overflow-x: hidden; touch-action: manipulation; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { display: none; width: 280px; background: white; border-right: 1px solid #d0dce7; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; font-size: 24px; color: #2196F3; font-weight: bold; }
        .nav-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #666; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px;}
        .nav-item:hover, .nav-item.active { background: #e3f2fd; color: #2196F3; }
        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .screen { display: none; padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .screen.active { display: block; }
        @media (min-width: 1024px) { .sidebar { display: block; } .main-content { margin-left: 280px; } .bottom-nav { display: none !important; } }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(33,150,243,0.08); text-align: center; border: 1px solid #e3f2fd; position: relative; }
        .card-value { font-size: 28px; font-weight: 700; color: #2196F3; }
        .card-label { font-size: 12px; color: #999; text-transform: uppercase; }
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 180px); }
        .messages { flex: 1; overflow-y: auto; margin-bottom: 16px; display: flex; flex-direction: column; gap: 10px; padding: 10px; }
        .message { display: flex; max-width: 85%; }
        .message.sent { align-self: flex-end; justify-content: flex-end; margin-left: auto; }
        .message-bubble { padding: 10px 14px; border-radius: 16px; font-size: 14px; word-wrap: break-word; }
        .message.sent .message-bubble { background: #2196F3; color: white; border-bottom-right-radius: 2px; }
        .message.received .message-bubble { background: #e3f2fd; color: #333; border-bottom-left-radius: 2px; }
        .chat-input-group { display: flex; gap: 8px; padding-top: 10px; border-top: 1px solid #eee; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; background: #2196F3; color: white; border: none; cursor: pointer; }
        #drawingCanvas { border: 2px solid #d0dce7; border-radius: 12px; background: white; touch-action: none; width: 100%; max-width: 600px; margin: 0 auto; display: block; }
        .postcards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
        .postcard { aspect-ratio: 3/4; background: white; padding: 5px; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); transform: rotate(-2deg); transition: transform 0.2s; }
        .postcard img { width: 100%; height: 100%; object-fit: cover; }
        .btn { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 5px; }
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; height: 60px; z-index: 1000; justify-content: space-around; align-items: center; }
        .nav-tab { background: none; border: none; color: #999; font-size: 11px; display: flex; flex-direction: column; align-items: center; }
        .nav-tab.active { color: #2196F3; }
        .nav-tab-icon { font-size: 20px; margin-bottom: 2px; }
        
        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        #loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #2196F3; transition: opacity 0.5s; }
    </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loader">
    <div style="font-size: 40px;">üíï</div>
    <div style="margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
</div>

<div class="container">
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="sidebar-header">üíï –ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="sidebar-nav">
            <button class="nav-item active" onclick="switchScreen('home')">üìä –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="nav-item" onclick="switchScreen('chat')">üí¨ –ß–∞—Ç</button>
            <button class="nav-item" onclick="switchScreen('wall')">üé® –°—Ç–µ–Ω–∞</button>
            <button class="nav-item" onclick="switchScreen('postcards')">üìÆ –û—Ç–∫—Ä—ã—Ç–∫–∏</button>
            <button class="nav-item" onclick="switchScreen('goals')">üéØ –¶–µ–ª–∏</button>
            <button class="nav-item" onclick="switchScreen('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- HOME -->
        <div class="screen active" id="home">
            <h1 style="font-size: 24px; margin-bottom: 5px;">–ù–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è</h1>
            <p style="margin-bottom: 20px; color: #666;">–í–º–µ—Å—Ç–µ —É–∂–µ <strong id="daysTogetherDisplay">...</strong></p>

            <div class="cards-grid">
                <div class="card"><div class="card-value" id="daysDisplay">0</div><div class="card-label">–î–Ω–µ–π</div></div>
                <div class="card"><div class="card-value" id="hoursDisplay">0</div><div class="card-label">–ß–∞—Å–æ–≤</div></div>
                <div class="card"><div class="card-value" id="minutesDisplay">0</div><div class="card-label">–ú–∏–Ω—É—Ç</div></div>
            </div>

            <h2 style="font-size: 18px; margin: 24px 0 10px;">–î–æ –î–Ω—è –†–æ–∂–¥–µ–Ω–∏—è</h2>
            <div class="cards-grid">
                <div class="card">
                    <div class="card-value" id="daysToP1">...</div>
                    <div class="card-label" id="person1NameDisplay">–û–Ω–∞</div>
                </div>
                <div class="card">
                    <div class="card-value" id="daysToP2">...</div>
                    <div class="card-label" id="person2NameDisplay">–û–Ω</div>
                </div>
            </div>

            <h2 style="font-size: 18px; margin: 24px 0 10px;">–í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã</h2>
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e3f2fd;">
                <input type="text" id="impName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–µ–∑–¥–∫–∞)">
                <input type="date" id="impDate">
                <button class="btn" onclick="addImportantDate()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É</button>
            </div>
            <div class="cards-grid" id="importantDatesGrid"></div>
        </div>

        <!-- CHAT -->
        <div class="screen" id="chat">
            <h1>üí¨ –ß–∞—Ç</h1>
            <div class="chat-container">
                <div class="messages" id="messages"></div>
                <div class="chat-input-group">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- WALL -->
        <div class="screen" id="wall">
            <h1>üé® –†–∏—Å—É–µ–º –≤–º–µ—Å—Ç–µ</h1>
            <canvas id="drawingCanvas" height="400"></canvas>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <input type="color" id="colorPicker" value="#e8a5b3" style="width: 50px; padding: 0;">
                <button class="btn" style="width: auto;" onclick="clearCanvas()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>

        <!-- POSTCARDS -->
        <div class="screen" id="postcards">
            <h1>üìÆ –û—Ç–∫—Ä—ã—Ç–∫–∏</h1>
            <div style="margin-bottom: 20px;">
                <label class="btn" style="display: block; text-align: center;">
                    üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                    <input type="file" id="imageUpload" accept="image/*" onchange="uploadPostcard(event)" style="display: none;">
                </label>
            </div>
            <div class="postcards-grid" id="postcardsGrid"></div>
        </div>

        <!-- GOALS -->
        <div class="screen" id="goals">
            <h1>üéØ –¶–µ–ª–∏</h1>
            <div style="margin-bottom: 20px;">
                <input type="text" id="goalName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏">
                <input type="date" id="goalDate">
                <button class="btn" onclick="addGoal()">‚ú® –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div id="goalsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <!-- SETTINGS -->
        <div class="screen" id="settings">
            <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <div style="display: flex; flex-direction: column; gap: 15px; background: white; padding: 15px; border-radius: 12px;">
                <label>–î–∞—Ç–∞ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞: <input type="date" id="meetingDate"></label>
                <label>–ò–º—è (–û–Ω–∞): <input type="text" id="p1Name"></label>
                <label>–î–† (–û–Ω–∞): <input type="date" id="p1Birth"></label>
                <label>–ò–º—è (–û–Ω): <input type="text" id="p2Name"></label>
                <label>–î–† (–û–Ω): <input type="date" id="p2Birth"></label>
                <button class="btn" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-tab active" onclick="switchScreen('home')"><span class="nav-tab-icon">üìä</span>–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="nav-tab" onclick="switchScreen('chat')"><span class="nav-tab-icon">üí¨</span>–ß–∞—Ç</button>
    <button class="nav-tab" onclick="switchScreen('wall')"><span class="nav-tab-icon">üé®</span>–°—Ç–µ–Ω–∞</button>
    <button class="nav-tab" onclick="switchScreen('postcards')"><span class="nav-tab-icon">üìÆ</span>–§–æ—Ç–æ</button>
</nav>

<script>
    // ===== 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE =====
    // –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –°–í–û–ô –ö–û–ù–§–ò–ì (–∏–∑ –®–∞–≥–∞ 1 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
    const firebaseConfig = {
        apiKey: "–í–°–¢–ê–í–¨–¢–ï_–°–Æ–î–ê_API_KEY",
        authDomain: "–í–ê–®_–ü–†–û–ï–ö–¢.firebaseapp.com",
        databaseURL: "https://–í–ê–®_–ü–†–û–ï–ö–¢-default-rtdb.firebaseio.com",
        projectId: "–í–ê–®_–ü–†–û–ï–ö–¢",
        storageBucket: "–í–ê–®_–ü–†–û–ï–ö–¢.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let appState = {
        settings: {
            meetingDate: '2024-01-01',
            p1Name: '–û–Ω–∞', p1Birth: '2000-01-01',
            p2Name: '–û–Ω', p2Birth: '2000-01-01'
        }
    };

    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–¥–ª—è —á–∞—Ç–∞)
    let deviceId = localStorage.getItem('deviceId');
    if (!deviceId) {
        deviceId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
    }

    // ===== 2. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –ë–ê–ó–û–ô =====
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    db.ref('settings').on('value', (snapshot) => {
        const val = snapshot.val();
        if (val) {
            appState.settings = val;
            updateCounters();
            renderSettingsInputs();
        }
        document.getElementById('loader').style.opacity = 0;
        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞
    db.ref('chat').limitToLast(50).on('value', (snapshot) => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        snapshot.forEach((child) => {
            const msg = child.val();
            const isMe = msg.deviceId === deviceId;
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `<div class="message-bubble">${msg.text}</div>`;
            messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–∂–Ω—ã—Ö –¥–∞—Ç
    db.ref('importantDates').on('value', (snapshot) => {
        const grid = document.getElementById('importantDatesGrid');
        grid.innerHTML = '';
        snapshot.forEach((child) => {
            const item = child.val();
            const key = child.key;
            
            // –†–∞—Å—á–µ—Ç –¥–Ω–µ–π
            const today = new Date();
            const target = new Date(item.date);
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            const daysText = diff >= 0 ? `–ß–µ—Ä–µ–∑ ${diff} –¥–Ω.` : '–ü—Ä–æ—à–ª–æ';

            grid.innerHTML += `
                <div class="card" style="position:relative;">
                    <button onclick="deleteItem('importantDates', '${key}')" style="position:absolute; right:5px; top:5px; border:none; background:none; color:red;">√ó</button>
                    <div class="card-value" style="font-size:20px">üìÖ</div>
                    <div class="card-label" style="font-size:14px; color:#333; margin-top:5px;">${item.name}</div>
                    <div style="font-size:12px; color:#2196F3;">${item.date}</div>
                    <div style="font-size:11px; color:#999;">${daysText}</div>
                </div>
            `;
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∫—Ä—ã—Ç–æ–∫
    db.ref('postcards').on('value', (snapshot) => {
        const grid = document.getElementById('postcardsGrid');
        grid.innerHTML = '';
        snapshot.forEach((child) => {
            const imgData = child.val();
            grid.innerHTML += `
                <div class="postcard">
                    <img src="${imgData}" onclick="alert('–û—Ç–∫—Ä—ã—Ç–∫–∞!')">
                </div>
            `;
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π
    db.ref('goals').on('value', (snapshot) => {
        const list = document.getElementById('goalsList');
        list.innerHTML = '';
        snapshot.forEach((child) => {
            const goal = child.val();
            const key = child.key;
            list.innerHTML += `
                <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #2196F3; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${goal.name}</div>
                        <div style="font-size:12px; color:#999;">${goal.date}</div>
                    </div>
                    <button onclick="deleteItem('goals', '${key}')" style="border:none; background:none; font-size:18px;">üóëÔ∏è</button>
                </div>
            `;
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –°—Ç–µ–Ω—ã (Canvas)
    let canvas = document.getElementById('drawingCanvas');
    let ctx = canvas.getContext('2d');
    
    // –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞
    function resizeCanvas() {
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth; 
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    db.ref('wall').on('value', (snapshot) => {
        const dataUrl = snapshot.val();
        if (dataUrl) {
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = dataUrl;
        }
    });

    // ===== 3. –§–£–ù–ö–¶–ò–ò UI =====

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-tab, .nav-item').forEach(b => b.classList.remove('active'));
        // –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
        const activeTabs = document.querySelectorAll(`[onclick="switchScreen('${id}')"]`);
        activeTabs.forEach(t => t.classList.add('active'));
        
        if(id === 'wall') resizeCanvas();
    }

    // –¢–∞–π–º–µ—Ä—ã –∏ —Å—á–µ—Ç—á–∏–∫–∏
    function updateCounters() {
        if (!appState.settings.meetingDate) return;
        
        // –°–∫–æ–ª—å–∫–æ –≤–º–µ—Å—Ç–µ
        const start = new Date(appState.settings.meetingDate);
        const now = new Date();
        const diff = now - start;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        
        document.getElementById('daysDisplay').innerText = days;
        document.getElementById('daysTogetherDisplay').innerText = days + ' –¥–Ω–µ–π';
        document.getElementById('hoursDisplay').innerText = Math.floor(diff / (1000 * 60 * 60));
        document.getElementById('minutesDisplay').innerText = Math.floor(diff / (1000 * 60));

        // –ò–º–µ–Ω–∞
        document.getElementById('person1NameDisplay').innerText = appState.settings.p1Name;
        document.getElementById('person2NameDisplay').innerText = appState.settings.p2Name;

        // –î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è
        calcBirthday(appState.settings.p1Birth, 'daysToP1');
        calcBirthday(appState.settings.p2Birth, 'daysToP2');
    }

    function calcBirthday(dateStr, elemId) {
        if (!dateStr) return;
        const today = new Date();
        const bday = new Date(dateStr);
        let nextBday = new Date(today.getFullYear(), bday.getMonth(), bday.getDate());
        if (today > nextBday) nextBday.setFullYear(today.getFullYear() + 1);
        const daysLeft = Math.ceil((nextBday - today) / (1000 * 60 * 60 * 24));
        document.getElementById(elemId).innerText = daysLeft;
    }

    setInterval(updateCounters, 10000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫

    // –ß–∞—Ç
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (text) {
            db.ref('chat').push({
                text: text,
                deviceId: deviceId,
                timestamp: Date.now()
            });
            input.value = '';
        }
    }

    // –í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã
    function addImportantDate() {
        const name = document.getElementById('impName').value;
        const date = document.getElementById('impDate').value;
        if (name && date) {
            db.ref('importantDates').push({ name, date });
            document.getElementById('impName').value = '';
            document.getElementById('impDate').value = '';
            alert('–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        }
    }

    // –¶–µ–ª–∏
    function addGoal() {
        const name = document.getElementById('goalName').value;
        const date = document.getElementById('goalDate').value;
        if (name && date) {
            db.ref('goals').push({ name, date });
            document.getElementById('goalName').value = '';
            alert('–¶–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function deleteItem(node, key) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
            db.ref(node).child(key).remove();
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    function renderSettingsInputs() {
        document.getElementById('meetingDate').value = appState.settings.meetingDate || '';
        document.getElementById('p1Name').value = appState.settings.p1Name || '';
        document.getElementById('p1Birth').value = appState.settings.p1Birth || '';
        document.getElementById('p2Name').value = appState.settings.p2Name || '';
        document.getElementById('p2Birth').value = appState.settings.p2Birth || '';
    }

    function saveSettings() {
        const newSettings = {
            meetingDate: document.getElementById('meetingDate').value,
            p1Name: document.getElementById('p1Name').value,
            p1Birth: document.getElementById('p1Birth').value,
            p2Name: document.getElementById('p2Name').value,
            p2Birth: document.getElementById('p2Birth').value
        };
        db.ref('settings').set(newSettings);
        alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!');
    }

    // –°—Ç–µ–Ω–∞ (–†–∏—Å–æ–≤–∞–Ω–∏–µ)
    let isDrawing = false;
    let lastX = 0; let lastY = 0;

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchend', stopDraw);

    function startDraw(e) {
        isDrawing = true;
        const pos = getPos(e);
        lastX = pos.x; lastY = pos.y;
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault(); // —á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
        const pos = getPos(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = document.getElementById('colorPicker').value;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();

        lastX = pos.x; lastY = pos.y;
    }

    function stopDraw() {
        if (isDrawing) {
            isDrawing = false;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —à—Ç—Ä–∏—Ö–∞
            // –í–Ω–∏–º–∞–Ω–∏–µ: –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –ª—É—á—à–µ —Ä–∏—Å–æ–≤–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ :)
            const dataUrl = canvas.toDataURL('image/png');
            db.ref('wall').set(dataUrl);
        }
    }

    function clearCanvas() {
        if(confirm('–°—Ç–µ—Ä–µ—Ç—å —Ä–∏—Å—É–Ω–æ–∫ —É –≤—Å–µ—Ö?')) {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            db.ref('wall').set(null);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (–û—Ç–∫—Ä—ã—Ç–∫–∏)
    function uploadPostcard(event) {
        const file = event.target.files[0];
        if (!file) return;

        // –°–∂–∏–º–∞–µ–º —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (Firebase Realtime DB –Ω–µ –ª—é–±–∏—Ç –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã)
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const tempCanvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–æ 600px –ø–æ —à–∏—Ä–∏–Ω–µ
                const maxSize = 600;
                if (width > maxSize) {
                    height = height * (maxSize / width);
                    width = maxSize;
                }
                
                tempCanvas.width = width;
                tempCanvas.height = height;
                const tCtx = tempCanvas.getContext('2d');
                tCtx.drawImage(img, 0, 0, width, height);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–∂–∞—Ç—É—é —Å—Ç—Ä–æ–∫—É base64
                const compressedDataUrl = tempCanvas.toDataURL('image/jpeg', 0.7);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É
                db.ref('postcards').push(compressedDataUrl);
                alert('–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

</script>
</body>
</html>
